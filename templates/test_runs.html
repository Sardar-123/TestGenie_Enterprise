{% extends "base.html" %}

{% block title %}Test Runs - TestGenie Enterprise{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-2"><i class="bi bi-play-circle"></i> Test Runs</h1>
            <p class="mb-0">Execute and track your test suites and test cases</p>
        </div>
        <button class="btn btn-light" onclick="createTestRun()">
            <i class="bi bi-plus-circle"></i> New Test Run
        </button>
    </div>
</div>

<!-- Test Run Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-play-circle text-primary fs-1"></i>
                <h3 class="mt-2">{{ test_runs|length }}</h3>
                <p class="text-muted mb-0">Total Runs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-hourglass-split text-warning fs-1"></i>
                <h3 class="mt-2">0</h3>
                <p class="text-muted mb-0">In Progress</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-check-circle text-success fs-1"></i>
                <h3 class="mt-2">0</h3>
                <p class="text-muted mb-0">Completed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-x-circle text-danger fs-1"></i>
                <h3 class="mt-2">0</h3>
                <p class="text-muted mb-0">Failed</p>
            </div>
        </div>
    </div>
</div>

<!-- Test Runs List -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Test Execution History</h5>
    </div>
    <div class="card-body">
        {% if test_runs %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Run Name</th>
                            <th>Test Suite</th>
                            <th>Status</th>
                            <th>Executed By</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Results</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for test_run in test_runs %}
                        <tr>
                            <td>
                                <strong>{{ test_run.name }}</strong>
                                <br>
                                <small class="text-muted">ID: {{ test_run.id[:8] }}</small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ test_run.test_suite_id or 'N/A' }}</span>
                            </td>
                            <td>
                                {% set status_colors = {
                                    'Not Started': 'secondary',
                                    'In Progress': 'warning',
                                    'Completed': 'success',
                                    'Failed': 'danger',
                                    'Cancelled': 'dark'
                                } %}
                                <span class="badge bg-{{ status_colors.get(test_run.status, 'secondary') }}">
                                    {{ test_run.status }}
                                </span>
                            </td>
                            <td>
                                <i class="bi bi-person-circle me-1"></i>
                                {{ test_run.executed_by or 'System' }}
                            </td>
                            <td>
                                {% if test_run.started_at %}
                                    {{ test_run.started_at[:16].replace('T', ' ') }}
                                {% else %}
                                    <span class="text-muted">Not started</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if test_run.completed_at and test_run.started_at %}
                                    <span class="text-success">Completed</span>
                                {% elif test_run.started_at %}
                                    <span class="text-warning">Running...</span>
                                {% else %}
                                    <span class="text-muted">--</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if test_run.results %}
                                    <span class="text-success">{{ test_run.results|length }} tests</span>
                                {% else %}
                                    <span class="text-muted">No results</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewTestRun('{{ test_run.id }}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    {% if test_run.status == 'Not Started' %}
                                    <button class="btn btn-outline-success" onclick="startTestRun('{{ test_run.id }}')">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    {% endif %}
                                    {% if test_run.status == 'In Progress' %}
                                    <button class="btn btn-outline-warning" onclick="pauseTestRun('{{ test_run.id }}')">
                                        <i class="bi bi-pause"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-danger" onclick="deleteTestRun('{{ test_run.id }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-play-circle text-muted" style="font-size: 5rem;"></i>
                <h3 class="text-muted mt-4">No Test Runs Found</h3>
                <p class="text-muted mb-4">Create your first test run to start executing test cases</p>
                <button class="btn btn-primary btn-lg" onclick="createTestRun()">
                    <i class="bi bi-plus-circle"></i> Create Your First Test Run
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Create Test Run Modal -->
<div class="modal fade" id="createTestRunModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-play-circle"></i> Create New Test Run</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTestRunForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="runName" class="form-label">Test Run Name *</label>
                                <input type="text" class="form-control" id="runName" placeholder="e.g., Regression Test Run v1.0" required>
                            </div>
                            <div class="mb-3">
                                <label for="testSuite" class="form-label">Test Suite *</label>
                                <select class="form-select" id="testSuite" required>
                                    <option value="">Select a test suite...</option>
                                    <option value="suite1">Login Test Suite</option>
                                    <option value="suite2">API Test Suite</option>
                                    <option value="suite3">UI Test Suite</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="executedBy" class="form-label">Executed By</label>
                                <input type="text" class="form-control" id="executedBy" placeholder="Tester name" value="Admin User">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Test Run Configuration</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="autoExecute">
                                        <label class="form-check-label" for="autoExecute">
                                            Auto-execute test cases
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="stopOnFailure">
                                        <label class="form-check-label" for="stopOnFailure">
                                            Stop execution on first failure
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="generateReport" checked>
                                        <label class="form-check-label" for="generateReport">
                                            Generate execution report
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="emailNotification">
                                        <label class="form-check-label" for="emailNotification">
                                            Email notification on completion
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitTestRun()">
                    <i class="bi bi-play-circle"></i> Create & Start Test Run
                </button>
                <button type="button" class="btn btn-primary" onclick="submitTestRun(false)">
                    <i class="bi bi-plus-circle"></i> Create Test Run
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Details Modal -->
<div class="modal fade" id="testRunDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-info-circle"></i> Test Run Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testRunDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function createTestRun() {
    const modal = new bootstrap.Modal(document.getElementById('createTestRunModal'));
    modal.show();
}

function submitTestRun(autoStart = true) {
    const name = document.getElementById('runName').value.trim();
    const testSuite = document.getElementById('testSuite').value;
    const executedBy = document.getElementById('executedBy').value.trim();
    
    if (!name) {
        alert('Please enter a test run name');
        return;
    }
    
    if (!testSuite) {
        alert('Please select a test suite');
        return;
    }
    
    const testRunData = {
        name: name,
        test_suite_id: testSuite,
        executed_by: executedBy || 'System',
        auto_execute: document.getElementById('autoExecute').checked,
        stop_on_failure: document.getElementById('stopOnFailure').checked,
        generate_report: document.getElementById('generateReport').checked,
        email_notification: document.getElementById('emailNotification').checked
    };
    
    fetch('/api/test-runs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(testRunData)
    })
    .then(response => response.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('createTestRunModal')).hide();
        
        if (autoStart) {
            startTestRun(data.id);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating test run');
    });
}

function viewTestRun(runId) {
    // Load test run details
    const modal = new bootstrap.Modal(document.getElementById('testRunDetailsModal'));
    const content = document.getElementById('testRunDetailsContent');
    
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">Loading test run details...</p>
        </div>
    `;
    
    modal.show();
    
    // Simulate loading test run details
    setTimeout(() => {
        content.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Run Information</h6>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Name:</dt>
                                <dd class="col-sm-8">Sample Test Run</dd>
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8"><span class="badge bg-success">Completed</span></dd>
                                <dt class="col-sm-4">Started:</dt>
                                <dd class="col-sm-8">2024-01-15 10:30</dd>
                                <dt class="col-sm-4">Duration:</dt>
                                <dd class="col-sm-8">15 minutes</dd>
                                <dt class="col-sm-4">Executed by:</dt>
                                <dd class="col-sm-8">Admin User</dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Test Results</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Test Case</th>
                                            <th>Status</th>
                                            <th>Duration</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Login with valid credentials</td>
                                            <td><span class="badge bg-success">Passed</span></td>
                                            <td>2.3s</td>
                                            <td>-</td>
                                        </tr>
                                        <tr>
                                            <td>Login with invalid credentials</td>
                                            <td><span class="badge bg-success">Passed</span></td>
                                            <td>1.8s</td>
                                            <td>-</td>
                                        </tr>
                                        <tr>
                                            <td>Password reset functionality</td>
                                            <td><span class="badge bg-danger">Failed</span></td>
                                            <td>5.2s</td>
                                            <td>Email not sent</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }, 1500);
}

function startTestRun(runId) {
    if (confirm('Start executing this test run?')) {
        alert(`Test run ${runId} started (demo)`);
        // In real implementation, this would start the test execution
        setTimeout(() => location.reload(), 1000);
    }
}

function pauseTestRun(runId) {
    if (confirm('Pause this test run?')) {
        alert(`Test run ${runId} paused (demo)`);
    }
}

function deleteTestRun(runId) {
    if (confirm('Are you sure you want to delete this test run?')) {
        alert(`Test run ${runId} deleted (demo)`);
        // In real implementation, make API call to delete
        setTimeout(() => location.reload(), 1000);
    }
}

// Reset form when modal is closed
document.getElementById('createTestRunModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('createTestRunForm').reset();
    document.getElementById('executedBy').value = 'Admin User';
    document.getElementById('generateReport').checked = true;
});
</script>
{% endblock %}
